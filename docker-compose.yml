services:
  pig-family-hub:
    # 构建镜像配置
    build:
      context: .
      dockerfile: Dockerfile

    image: pig-family-hub:latest
    container_name: pig-family-hub

    # 建议使用 .env 或 CI/CD secret 注入敏感信息（见 .env.example）
    env_file:
      - .env

    ports:
      - "${PORT:-8080}:8080"

    # 卷：使用命名卷以便 Docker 管理存储；如果希望绑定主机目录，可改为 ./data:/app/data
    volumes:
      - data:/app/data
      - media:/app/media
      - uploads:/app/uploads

    environment:
      PORT: ${PORT:-8080}
      API_KEY: AIzaSyCt1RQjYuiTFG-D1_x62b69sHq0meX-2os
      ALLOWED_ORIGINS: ${ALLOWED_ORIGINS:-http://localhost:8080}
      NODE_ENV: ${NODE_ENV:-production}

    restart: unless-stopped

    # 健康检查：使用容器内 node 进程请求本地 /health
    healthcheck:
      test: [ "CMD", "node", "-e", "require('http').get('http://localhost:8080/health', r => { if (r.statusCode !== 200) process.exit(1) })" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

    # 如果你使用反向代理（例如 Traefik / Nginx），可在这里声明依赖或网络配置
    # depends_on:
    #   - reverse-proxy

    networks:
      - piggy-net

# 推荐：通过一个轻量的反向代理容器（可选）来处理 HTTPS / TLS
# 下面示例为 nginx 注释示例，按需开启
#  nginx:
#    image: nginx:stable-alpine
#    container_name: piggy-nginx
#    ports:
#      - "80:80"
#      - "443:443"
#    volumes:
#      - ./nginx.conf:/etc/nginx/nginx.conf:ro
#      - ./certs:/etc/letsencrypt:ro
#    depends_on:
#      - pig-family-hub
#    networks:
#      - piggy-net
#    restart: unless-stopped

networks:
  piggy-net:
    driver: bridge

volumes:
  data:
    driver: local
  media:
    driver: local
  uploads:
    driver: local
