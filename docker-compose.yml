version: '3.8'

services:
  pig-family-hub:
    # 构建镜像配置
    build:
      context: .
      dockerfile: Dockerfile
      args:
        # 从环境变量读取 API_KEY，构建时注入
        API_KEY: ${API_KEY:-default}
    
    # 镜像和容器名称
    image: pig-family-hub:latest
    container_name: pig-family-hub
    
    # 端口映射
    ports:
      - "${PORT:-8080}:8080"
    
    # 卷挂载
    volumes:
      # 数据库和博客归档持久化
      - ./data:/app/data
      # 媒体文件挂载目录
      - ./media:/app/media
    
    # 环境变量
    environment:
      # 服务器监听端口
      PORT: ${PORT:-8080}
      # Google Gemini API 密钥
      API_KEY: ${API_KEY:-default}
      # 允许的跨域来源（逗号分隔）
      ALLOWED_ORIGINS: ${ALLOWED_ORIGINS:-http://localhost:8080}
      # Node 环境
      NODE_ENV: ${NODE_ENV:-production}
    
    # 重启策略
    restart: unless-stopped
    
    # 健康检查
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s
    
    # 日志配置
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    
    # 依赖关系（如有其他服务）
    # depends_on:
    #   - database

  # 可选：Nginx 反向代理（用于 HTTPS）
  # nginx:
  #   image: nginx:latest
  #   container_name: pig-family-hub-nginx
  #   ports:
  #     - "80:80"
  #     - "443:443"
  #   volumes:
  #     - ./nginx.conf:/etc/nginx/nginx.conf
  #     - /etc/letsencrypt:/etc/letsencrypt
  #   depends_on:
  #     - pig-family-hub
  #   restart: unless-stopped

# 网络配置（可选）
networks:
  default:
    name: pig-family-network
    driver: bridge

# 卷配置（可选，如需命名卷）
volumes:
  data:
    driver: local
  media:
    driver: local
